{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto print:w-full animate-fade-in-up">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 no-print gap-4">
        <h2 class="text-3xl font-bold text-medical-900">Analysis Results</h2>
        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
            <button id="edit-btn" onclick="toggleEditMode()" class="w-full sm:w-auto text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg active:scale-95 flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                Edit
            </button>
            <button id="add-row-btn" onclick="addTestRow()" class="hidden w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg active:scale-95 flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Add Test
            </button>
            <button id="save-btn" onclick="saveChanges()" class="hidden w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg active:scale-95 flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                Save & Re-Analyze
            </button>
            <button id="cancel-btn" onclick="cancelEdit()" class="hidden w-full sm:w-auto text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg active:scale-95 flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                Cancel
            </button>
            <button onclick="window.print()" class="w-full sm:w-auto text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg active:scale-95 flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Export PDF
            </button>
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-lg p-6 sm:p-8 mb-8 transition-all duration-300 hover:shadow-xl" id="report-content">
        <div class="border-b border-gray-200 pb-4 mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Medical Report Analysis</h1>
                <p class="text-sm text-gray-500">Generated by AI Assistant</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600"><span class="font-semibold">Patient:</span> <span class="editable-field" data-key="patient_name">{{ results.patient_name or 'Unknown' }}</span></p>
                <p class="text-sm text-gray-600"><span class="font-semibold">Date:</span> <span class="editable-field" data-key="date">{{ results.date or 'Unknown' }}</span></p>
            </div>
        </div>

        {% if results.summary %}
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">AI Summary</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>{{ results.summary }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if results.recommendations %}
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-green-800">Recommendations</h3>
                    <ul class="mt-2 list-disc list-inside text-sm text-green-700">
                        {% for rec in results.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Desktop Table View (Hidden on Mobile) -->
        <div class="hidden md:block relative overflow-x-auto rounded-lg border border-gray-200">
            <table class="w-full text-sm text-left text-gray-500 table-fixed" id="desktop-table">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 w-1/4">Test Name</th>
                        <th scope="col" class="px-4 py-3 w-1/6">Result</th>
                        <th scope="col" class="px-4 py-3 w-1/6">Reference Range</th>
                        <th scope="col" class="px-4 py-3 w-1/12">Status</th>
                        <th scope="col" class="px-4 py-3 w-1/3">Insight</th>
                    </tr>
                </thead>
                <tbody id="desktop-table-body">
                    {% for test in results.tests %}
                    <tr class="bg-white border-b hover:bg-gray-50 test-row">
                        <th scope="row" class="px-4 py-4 font-medium text-gray-900 break-words editable-cell" data-key="name">
                            {{ test.name }}
                        </th>
                        <td class="px-4 py-4 break-words editable-cell" data-key="value">
                            {{ test.value }} {{ test.unit }}
                        </td>
                        <td class="px-4 py-4 break-words editable-cell" data-key="range">
                            {{ test.range }}
                        </td>
                        <td class="px-4 py-4">
                            {% if test.status == 'High' %}
                                <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">High</span>
                            {% elif test.status == 'Low' %}
                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">Low</span>
                            {% else %}
                                <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">Normal</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 text-gray-900 break-words text-xs">
                            {{ test.insight or '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View (Visible only on Mobile) -->
        <div class="md:hidden space-y-4" id="mobile-cards-container">
            {% for test in results.tests %}
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 test-card">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-gray-900 text-lg editable-cell" data-key="name">{{ test.name }}</h3>
                    {% if test.status == 'High' %}
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">High</span>
                    {% elif test.status == 'Low' %}
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">Low</span>
                    {% else %}
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">Normal</span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-xs text-gray-500 uppercase">Result</p>
                        <p class="font-semibold text-gray-900 editable-cell" data-key="value">{{ test.value }} {{ test.unit }}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-xs text-gray-500 uppercase">Range</p>
                        <p class="text-gray-700 editable-cell" data-key="range">{{ test.range }}</p>
                    </div>
                </div>

                {% if test.insight %}
                <div class="pt-2 border-t border-gray-100">
                    <p class="text-xs text-gray-500 uppercase mb-1">Insight</p>
                    <p class="text-sm text-gray-700">{{ test.insight }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-8 text-xs text-gray-400 text-center border-t border-gray-100 pt-4">
            <p>Disclaimer: This analysis is generated by AI and should not be considered medical advice. Always consult with a qualified healthcare professional.</p>
        </div>
    </div>
</div>

<script>
    let originalData = {};

    function toggleEditMode() {
        const editBtn = document.getElementById('edit-btn');
        const isEditing = editBtn.classList.contains('hidden');
        
        // If we are STARTING edit mode (button is visible before toggle)
        if (!isEditing) {
            // Backup data
            originalData = {
                patient_name: document.querySelector('[data-key="patient_name"]').innerText,
                date: document.querySelector('[data-key="date"]').innerText,
                desktop_html: document.getElementById('desktop-table-body').innerHTML,
                mobile_html: document.getElementById('mobile-cards-container').innerHTML
            };
        }

        // Toggle Buttons
        document.getElementById('edit-btn').classList.toggle('hidden');
        document.getElementById('save-btn').classList.toggle('hidden');
        document.getElementById('cancel-btn').classList.toggle('hidden');
        document.getElementById('add-row-btn').classList.toggle('hidden');
        
        // Toggle ContentEditable
        const editableElements = document.querySelectorAll('.editable-cell, .editable-field');
        editableElements.forEach(el => {
            const inEditMode = document.getElementById('edit-btn').classList.contains('hidden');
            
            el.contentEditable = inEditMode;
            if (inEditMode) {
                el.classList.add('border', 'border-blue-300', 'rounded', 'bg-blue-50', 'px-1', 'cursor-text');
            } else {
                el.classList.remove('border', 'border-blue-300', 'rounded', 'bg-blue-50', 'px-1', 'cursor-text');
            }
        });
    }

    function addTestRow() {
        // Add to Desktop Table
        const tbody = document.getElementById('desktop-table-body');
        const newRow = document.createElement('tr');
        newRow.className = "bg-white border-b hover:bg-gray-50 test-row";
        newRow.innerHTML = `
            <th scope="row" class="px-4 py-4 font-medium text-gray-900 break-words editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="name">New Test</th>
            <td class="px-4 py-4 break-words editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="value">0</td>
            <td class="px-4 py-4 break-words editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="range">0-0</td>
            <td class="px-4 py-4"><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">Pending</span></td>
            <td class="px-4 py-4 text-gray-900 break-words text-xs">-</td>
        `;
        tbody.appendChild(newRow);

        // Add to Mobile Cards
        const cardContainer = document.getElementById('mobile-cards-container');
        const newCard = document.createElement('div');
        newCard.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 test-card";
        newCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-gray-900 text-lg editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="name">New Test</h3>
                <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">Pending</span>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-3">
                <div class="bg-gray-50 p-2 rounded">
                    <p class="text-xs text-gray-500 uppercase">Result</p>
                    <p class="font-semibold text-gray-900 editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="value">0</p>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                    <p class="text-xs text-gray-500 uppercase">Range</p>
                    <p class="text-gray-700 editable-cell border border-blue-300 rounded bg-blue-50 px-1 cursor-text" contenteditable="true" data-key="range">0-0</p>
                </div>
            </div>
        `;
        cardContainer.appendChild(newCard);
    }

    function cancelEdit() {
        // Restore original data
        if (originalData.patient_name) {
            document.querySelector('[data-key="patient_name"]').innerText = originalData.patient_name;
            document.querySelector('[data-key="date"]').innerText = originalData.date;
            document.getElementById('desktop-table-body').innerHTML = originalData.desktop_html;
            document.getElementById('mobile-cards-container').innerHTML = originalData.mobile_html;
        }

        // Exit edit mode (hide buttons, remove contentEditable)
        document.getElementById('edit-btn').classList.remove('hidden');
        document.getElementById('save-btn').classList.add('hidden');
        document.getElementById('cancel-btn').classList.add('hidden');
        document.getElementById('add-row-btn').classList.add('hidden');

        const editableElements = document.querySelectorAll('.editable-cell, .editable-field');
        editableElements.forEach(el => {
            el.contentEditable = false;
            el.classList.remove('border', 'border-blue-300', 'rounded', 'bg-blue-50', 'px-1', 'cursor-text');
        });
    }

    async function saveChanges() {
        const saveBtn = document.getElementById('save-btn');
        const originalText = saveBtn.innerText;
        saveBtn.innerText = 'Analyzing...';
        saveBtn.disabled = true;

        const data = {
            patient_name: document.querySelector('[data-key="patient_name"]').innerText.trim(),
            date: document.querySelector('[data-key="date"]').innerText.trim(),
            tests: []
        };

        // Determine which view is visible to scrape data from
        const desktopTable = document.getElementById('desktop-table');
        // Check if desktop table is visible (display: block/table)
        // The class is 'hidden md:block'.
        // We can check window width or offsetParent
        const isDesktop = window.getComputedStyle(desktopTable.parentElement).display !== 'none';

        if (isDesktop) {
            const rows = document.querySelectorAll('#desktop-table-body tr');
            rows.forEach(row => {
                data.tests.push({
                    name: row.querySelector('[data-key="name"]').innerText.trim(),
                    value: row.querySelector('[data-key="value"]').innerText.trim(),
                    unit: "", // Unit is mixed with value, AI will handle it
                    range: row.querySelector('[data-key="range"]').innerText.trim(),
                    status: "Normal", // Placeholder, AI will update
                    insight: null
                });
            });
        } else {
            const cards = document.querySelectorAll('#mobile-cards-container .test-card');
            cards.forEach(card => {
                data.tests.push({
                    name: card.querySelector('[data-key="name"]').innerText.trim(),
                    value: card.querySelector('[data-key="value"]').innerText.trim(),
                    unit: "",
                    range: card.querySelector('[data-key="range"]').innerText.trim(),
                    status: "Normal",
                    insight: null
                });
            });
        }

        try {
            const response = await fetch('/analysis/reanalyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
            } else {
                alert('Failed to re-analyze data. Please try again.');
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
            saveBtn.innerText = originalText;
            saveBtn.disabled = false;
        }
    }
</script>

<style>
    @media print {
        .no-print { display: none !important; }
        nav { display: none !important; }
        footer { display: none !important; }
        body { background-color: white; }
        main { padding: 0; margin: 0; width: 100%; max-width: 100%; }
        #report-content { box-shadow: none; border: none; padding: 0; }
    }
</style>
{% endblock %}